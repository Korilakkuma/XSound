import type { Inputs, Outputs, Parameters } from '/src/worklet';

import { AudioContextMock } from '/mock/AudioContextMock';
import { createModule, addAudioWorklet } from '/src/worklet';

// Cannot keep class name
class AudioWorkletProcessor {}

class CustomProcessor extends AudioWorkletProcessor {
  public static get parameterDescriptors() {
    return [{
      name          : 'depth',
      defaultValue  : 0,
      minValue      : 0,
      maxValue      : 1,
      automationRate: 'a-rate'
    }];
  }

  public process(inputs: Inputs, outputs: Outputs, _parameters: Parameters): boolean {
    const input  = inputs[0];
    const output = outputs[0];

    for (let channel = 0, len = input.length; channel < len; channel++) {
      const i = input[channel];
      const o = output[channel];

      if (i) {
        i.set(o);
      }
    }

    return true;
  }
}

describe(createModule.name, () => {
  test('should Data URL for AudioWorklet', () => {
    // @ts-expect-error Because there is not Web Audio API in Jest environment (Node.js environment), mocks Web Audio API
    expect(createModule(CustomProcessor)).toBe('data:text/javascript,class%20OverlapAddProcessor%20extends%20AudioWorkletProcessor%20%7B%0A%20%20%20%20static%20RENDER_QUANTUM_SIZE%20%3D%20128%3B%0A%20%20%20%20numberOfInputs%20%3D%201%3B%0A%20%20%20%20numberOfOutputs%20%3D%201%3B%0A%20%20%20%20blockSize%20%3D%201024%3B%0A%20%20%20%20hopSize%20%3D%20128%3B%0A%20%20%20%20numberOfOverlaps%3B%0A%20%20%20%20inputBuffers%3B%0A%20%20%20%20inputBuffersHead%3B%0A%20%20%20%20inputBuffersToSend%3B%0A%20%20%20%20outputBuffers%3B%0A%20%20%20%20outputBuffersToRetrieve%3B%0A%20%20%20%20constructor(options)%20%7B%0A%20%20%20%20%20%20%20%20super(options)%3B%0A%20%20%20%20%20%20%20%20this.numberOfInputs%20%3D%20options.numberOfInputs%20%3F%3F%201%3B%0A%20%20%20%20%20%20%20%20this.numberOfOutputs%20%3D%20options.numberOfOutputs%20%3F%3F%201%3B%0A%20%20%20%20%20%20%20%20if%20(options.processorOptions)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.blockSize%20%3D%20options.processorOptions.blockSize%20%3F%3F%201024%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20this.numberOfOverlaps%20%3D%20this.blockSize%20%2F%20this.hopSize%3B%0A%20%20%20%20%20%20%20%20this.inputBuffers%20%3D%20new%20Array(this.numberOfInputs)%3B%0A%20%20%20%20%20%20%20%20this.inputBuffersHead%20%3D%20new%20Array(this.numberOfInputs)%3B%0A%20%20%20%20%20%20%20%20this.inputBuffersToSend%20%3D%20new%20Array(this.numberOfInputs)%3B%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfInputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.allocateInputChannels(index%2C%201)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20this.outputBuffers%20%3D%20new%20Array(this.numberOfOutputs)%3B%0A%20%20%20%20%20%20%20%20this.outputBuffersToRetrieve%20%3D%20new%20Array(this.numberOfOutputs)%3B%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfOutputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.allocateOutputChannels(index%2C%201)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%2F**%20%40override%20*%2F%0A%20%20%20%20process(inputs%2C%20outputs%2C%20parameters)%20%7B%0A%20%20%20%20%20%20%20%20this.reallocateChannelsIfNeeded(inputs%2C%20outputs)%3B%0A%20%20%20%20%20%20%20%20this.readInputs(inputs)%3B%0A%20%20%20%20%20%20%20%20this.shiftInputBuffers()%3B%0A%20%20%20%20%20%20%20%20this.prepareInputBuffersToSend()%3B%0A%20%20%20%20%20%20%20%20this.processOverlapAdd(this.inputBuffersToSend%2C%20this.outputBuffersToRetrieve%2C%20parameters)%3B%0A%20%20%20%20%20%20%20%20this.handleOutputBuffersToRetrieve()%3B%0A%20%20%20%20%20%20%20%20this.writeOutputs(outputs)%3B%0A%20%20%20%20%20%20%20%20this.shiftOutputBuffers()%3B%0A%20%20%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20reallocateChannelsIfNeeded(inputs%2C%20outputs)%20%7B%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfInputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20numberOfChannels%20%3D%20inputs%5Bindex%5D.length%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(numberOfChannels%20!%3D%3D%20this.inputBuffers%5Bindex%5D.length)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.allocateInputChannels(index%2C%20numberOfChannels)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfOutputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20numberOfChannels%20%3D%20outputs%5Bindex%5D.length%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(numberOfChannels%20!%3D%3D%20this.outputBuffers%5Bindex%5D.length)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.allocateOutputChannels(index%2C%20numberOfChannels)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20allocateInputChannels(index%2C%20numberOfChannels)%20%7B%0A%20%20%20%20%20%20%20%20this.inputBuffers%5Bindex%5D%20%3D%20new%20Array(numberOfChannels)%3B%0A%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20numberOfChannels%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.inputBuffers%5Bindex%5D%5BchannelNumber%5D%20%3D%20new%20Float32Array(this.blockSize%20%2B%20OverlapAddProcessor.RENDER_QUANTUM_SIZE)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.inputBuffers%5Bindex%5D%5BchannelNumber%5D.fill(0)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20this.inputBuffersHead%5Bindex%5D%20%3D%20new%20Array(numberOfChannels)%3B%0A%20%20%20%20%20%20%20%20this.inputBuffersToSend%5Bindex%5D%20%3D%20new%20Array(numberOfChannels)%3B%0A%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20numberOfChannels%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.inputBuffersHead%5Bindex%5D%5BchannelNumber%5D%20%3D%20this.inputBuffers%5Bindex%5D%5BchannelNumber%5D.subarray(0%2C%20this.blockSize)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.inputBuffersToSend%5Bindex%5D%5BchannelNumber%5D%20%3D%20new%20Float32Array(this.blockSize)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20allocateOutputChannels(index%2C%20numberOfChannels)%20%7B%0A%20%20%20%20%20%20%20%20this.outputBuffers%5Bindex%5D%20%3D%20new%20Array(numberOfChannels)%3B%0A%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20numberOfChannels%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.outputBuffers%5Bindex%5D%5BchannelNumber%5D%20%3D%20new%20Float32Array(this.blockSize)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.outputBuffers%5Bindex%5D%5BchannelNumber%5D.fill(0)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20this.outputBuffersToRetrieve%5Bindex%5D%20%3D%20new%20Array(numberOfChannels)%3B%0A%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20numberOfChannels%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.outputBuffersToRetrieve%5Bindex%5D%5BchannelNumber%5D%20%3D%20new%20Float32Array(this.blockSize)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20this.outputBuffersToRetrieve%5Bindex%5D%5BchannelNumber%5D.fill(0)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20readInputs(inputs)%20%7B%0A%20%20%20%20%20%20%20%20if%20(inputs%5B0%5D.length%20%26%26%20(inputs%5B0%5D%5B0%5D.length%20%3D%3D%3D%200))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfInputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20this.inputBuffers%5Bindex%5D.length%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.inputBuffers%5Bindex%5D%5BchannelNumber%5D.fill(0%2C%20this.blockSize)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfInputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20this.inputBuffers%5Bindex%5D.length%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.inputBuffers%5Bindex%5D%5BchannelNumber%5D.set(inputs%5Bindex%5D%5BchannelNumber%5D%2C%20this.blockSize)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20writeOutputs(outputs)%20%7B%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfOutputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20this.inputBuffers%5Bindex%5D.length%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20outputs%5Bindex%5D%5BchannelNumber%5D.set(this.outputBuffers%5Bindex%5D%5BchannelNumber%5D.subarray(0%2C%20OverlapAddProcessor.RENDER_QUANTUM_SIZE))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20shiftInputBuffers()%20%7B%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfInputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20this.inputBuffers%5Bindex%5D.length%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.inputBuffers%5Bindex%5D%5BchannelNumber%5D.copyWithin(0%2C%20OverlapAddProcessor.RENDER_QUANTUM_SIZE)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20shiftOutputBuffers()%20%7B%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfOutputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20this.outputBuffers%5Bindex%5D.length%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.outputBuffers%5Bindex%5D%5BchannelNumber%5D.copyWithin(0%2C%20OverlapAddProcessor.RENDER_QUANTUM_SIZE)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.outputBuffers%5Bindex%5D%5BchannelNumber%5D.subarray(this.blockSize%20-%20OverlapAddProcessor.RENDER_QUANTUM_SIZE).fill(0)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20prepareInputBuffersToSend()%20%7B%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfInputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20this.inputBuffers%5Bindex%5D.length%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.inputBuffersToSend%5Bindex%5D%5BchannelNumber%5D.set(this.inputBuffersHead%5Bindex%5D%5BchannelNumber%5D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20handleOutputBuffersToRetrieve()%20%7B%0A%20%20%20%20%20%20%20%20for%20(let%20index%20%3D%200%3B%20index%20%3C%20this.numberOfOutputs%3B%20index%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20channelNumber%20%3D%200%3B%20channelNumber%20%3C%20this.outputBuffers%5Bindex%5D.length%3B%20channelNumber%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20(let%20n%20%3D%200%3B%20n%20%3C%20this.blockSize%3B%20n%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.outputBuffers%5Bindex%5D%5BchannelNumber%5D%5Bn%5D%20%2B%3D%20this.outputBuffersToRetrieve%5Bindex%5D%5BchannelNumber%5D%5Bn%5D%20%2F%20this.numberOfOverlaps%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D; class%20CustomProcessor%20extends%20AudioWorkletProcessor%20%7B%0A%20%20%20%20static%20get%20parameterDescriptors()%20%7B%0A%20%20%20%20%20%20%20%20return%20%5B%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3A%20\'depth\'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20defaultValue%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20minValue%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20maxValue%3A%201%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20automationRate%3A%20\'a-rate\'%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%5D%3B%0A%20%20%20%20%7D%0A%20%20%20%20process(inputs%2C%20outputs%2C%20_parameters)%20%7B%0A%20%20%20%20%20%20%20%20const%20input%20%3D%20inputs%5B0%5D%3B%0A%20%20%20%20%20%20%20%20const%20output%20%3D%20outputs%5B0%5D%3B%0A%20%20%20%20%20%20%20%20for%20(let%20channel%20%3D%200%2C%20len%20%3D%20input.length%3B%20channel%20%3C%20len%3B%20channel%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20i%20%3D%20input%5Bchannel%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20o%20%3D%20output%5Bchannel%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(i)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20i.set(o)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%7D%0A%7D; registerProcessor(\'CustomProcessor\', CustomProcessor)');
  });
});

describe(addAudioWorklet.name, () => {
  test('should add `AudioWorklet` and return `Promise`', () => {
    const context = new AudioContextMock();

    // @ts-expect-error Because there is not Web Audio API in Jest environment (Node.js environment), mocks Web Audio API
    expect(addAudioWorklet(context, CustomProcessor)).toBeInstanceOf(Promise);
  });
});
